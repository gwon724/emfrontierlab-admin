# 📱 카카오 알림톡 전송 가이드

## 📋 목차
1. [개요](#개요)
2. [API 요구사항](#api-요구사항)
3. [전송 가능한 메시지 유형](#전송-가능한-메시지-유형)
4. [설정 방법](#설정-방법)
5. [사용 방법](#사용-방법)
6. [문제 해결](#문제-해결)

---

## 개요

현재 시스템은 **NHN Cloud (구 TOAST)의 알림톡 API**를 사용하여 카카오 알림톡을 전송합니다.

### ✅ 현재 구현된 기능
- 관리자 대시보드에서 클라이언트에게 직접 알림톡 발송
- 5가지 템플릿 기반 메시지 전송
- 자동 날짜/시간 포맷팅
- 전화번호 자동 검증 및 정규화

### ⚠️ 필요한 것
**반드시 API 키가 필요합니다!**
- NHN Cloud 계정
- 알림톡 서비스 활성화
- 카카오 발신 프로필 등록
- 템플릿 사전 등록 및 승인

---

## API 요구사항

### 1️⃣ **NHN Cloud 가입 및 설정**

```
1. NHN Cloud 회원가입
   → https://console.nhncloud.com/

2. 프로젝트 생성
   → 프로젝트 이름: EMFRONTIER (또는 원하는 이름)

3. Notification > KakaoTalk Bizmessage 서비스 활성화
   → 상품 활성화 버튼 클릭

4. API 키 발급
   → 프로젝트 설정 > API 보안 설정
   → AppKey 복사
   → SecretKey 생성 및 복사
```

### 2️⃣ **카카오톡 채널 및 발신 프로필**

```
1. 카카오톡 채널 관리자 센터 접속
   → https://center-pf.kakao.com/

2. 비즈니스 채널 생성
   → 채널명: EMFRONTIER (또는 원하는 이름)
   → 검색 허용 설정
   → 카카오 검수 대기 (1-3일 소요)

3. 발신 프로필 키 확인
   → NHN Cloud 콘솔에서 발신 프로필 연동
   → Sender Key 복사
```

### 3️⃣ **템플릿 등록 및 승인**

현재 시스템에서 사용하는 5가지 템플릿을 NHN Cloud 콘솔에 등록해야 합니다:

#### 📌 템플릿 1: 신청 접수 (EMF_001)
```
[EMFRONTIER] 정책자금 신청 접수 완료

안녕하세요, #{고객명}님!

#{정책자금명} 신청이 정상적으로 접수되었습니다.

▪️ 신청일: #{신청일}
▪️ 신청금액: #{신청금액}

심사 진행 상황은 알림톡으로 안내드리겠습니다.

감사합니다.
```

#### 📌 템플릿 2: 심사 진행 (EMF_002)
```
[EMFRONTIER] 심사 진행 안내

안녕하세요, #{고객명}님!

#{정책자금명}의 심사가 진행 중입니다.

▪️ 현재 상태: #{상태}
▪️ 진행일: #{진행일}

심사 완료 시 다시 안내드리겠습니다.
```

#### 📌 템플릿 3: 승인 완료 (EMF_003)
```
[EMFRONTIER] 승인 완료 안내

축하합니다, #{고객명}님!

#{정책자금명} 신청이 승인되었습니다.

▪️ 승인금액: #{승인금액}
▪️ 승인일: #{승인일}

자세한 내용은 대시보드에서 확인하실 수 있습니다.
```

#### 📌 템플릿 4: 서류 보완 (EMF_004)
```
[EMFRONTIER] 서류 보완 요청

안녕하세요, #{고객명}님!

심사 진행을 위해 추가 서류가 필요합니다.

▪️ 보완 내용: #{보완내용}
▪️ 제출 기한: #{기한}

기한 내 미제출 시 심사가 중단될 수 있습니다.
```

#### 📌 템플릿 5: 반려 (EMF_005)
```
[EMFRONTIER] 심사 결과 안내

안녕하세요, #{고객명}님!

#{정책자금명} 신청이 반려되었습니다.

▪️ 반려 사유: #{반려사유}
▪️ 반려일: #{반려일}

재심사를 원하시면 대시보드에서 요청해주세요.
```

### 4️⃣ **환경 변수 설정**

`.env.local` 파일을 프로젝트 루트에 생성하고 다음 내용을 추가:

```bash
# NHN Cloud 알림톡 API 키
KAKAO_ALIMTALK_APP_KEY=your_app_key_here
KAKAO_ALIMTALK_SECRET_KEY=your_secret_key_here
KAKAO_SENDER_KEY=your_sender_key_here
```

**예시:**
```bash
KAKAO_ALIMTALK_APP_KEY=aBcDeFgHiJkLmNoPqRsTuVwXyZ123456
KAKAO_ALIMTALK_SECRET_KEY=xYz987654321AbCdEfGhIjKlMnOpQrSt
KAKAO_SENDER_KEY=abc123def456ghi789jklmno
```

---

## 전송 가능한 메시지 유형

### 1. **신청 접수 알림** (`application_received`)
- **전송 시점**: 클라이언트가 정책자금 신청을 완료했을 때
- **필요 정보**:
  - 고객명 (자동)
  - 신청일 (자동)
  - 정책자금명 (자동)
  - 신청금액 (입력 필요)
- **버튼**: "상세보기" → 클라이언트 대시보드 링크

### 2. **심사 진행 알림** (`in_progress`)
- **전송 시점**: 신청 상태가 변경되었을 때
- **필요 정보**:
  - 고객명 (자동)
  - 현재 상태 (자동 - DB에서 가져옴)
  - 정책자금명 (자동)
  - 진행일 (자동)
- **버튼**: "상세보기" → 클라이언트 대시보드 링크

### 3. **승인 완료 알림** (`approved`)
- **전송 시점**: 정책자금 신청이 승인되었을 때
- **필요 정보**:
  - 고객명 (자동)
  - 정책자금명 (자동)
  - 승인금액 (입력 필요)
  - 승인일 (자동)
- **버튼**: "상세보기" → 클라이언트 대시보드 링크

### 4. **서류 보완 요청** (`supplement`)
- **전송 시점**: 추가 서류가 필요할 때
- **필요 정보**:
  - 고객명 (자동)
  - 보완 내용 (입력 필요)
  - 제출 기한 (입력 필요, 기본값: "7일 이내")
- **버튼**: "서류 제출하기" → 클라이언트 대시보드 링크

### 5. **반려 알림** (`rejected`)
- **전송 시점**: 신청이 반려되었을 때
- **필요 정보**:
  - 고객명 (자동)
  - 정책자금명 (자동)
  - 반려 사유 (입력 필요)
  - 반려일 (자동)
- **버튼**: "재심사 요청" → 클라이언트 대시보드 링크

---

## 설정 방법

### Step 1: 환경 변수 설정

```bash
# 프로젝트 루트 디렉토리에서
cd /home/user/webapp

# .env.local 파일 생성
cat > .env.local << 'EOF'
KAKAO_ALIMTALK_APP_KEY=실제_앱키_입력
KAKAO_ALIMTALK_SECRET_KEY=실제_시크릿키_입력
KAKAO_SENDER_KEY=실제_발신프로필키_입력
EOF
```

### Step 2: 서버 재시작

```bash
# Next.js 개발 서버 재시작 (환경 변수 로드를 위해)
npm run dev -- -p 3001
```

### Step 3: 테스트 전송

1. 관리자 사이트 접속
2. 클라이언트 선택 (전화번호가 등록된 클라이언트)
3. "📱 카카오 알림톡 발송" 버튼 클릭
4. 메시지 유형 선택
5. 필요한 정보 입력
6. "알림톡 발송" 버튼 클릭

---

## 사용 방법

### 관리자 대시보드에서 전송

1. **클라이언트 목록에서 클라이언트 클릭**
   - 클라이언트 상세 모달이 열림

2. **"📱 카카오 알림톡 발송" 버튼 클릭**
   - ⚠️ 전화번호가 없는 클라이언트는 버튼이 비활성화됨

3. **알림톡 발송 모달에서 설정**
   - **알림 유형 선택**: 드롭다운에서 메시지 유형 선택
   - **추가 정보 입력** (유형에 따라 다름):
     - `신청 접수`: 신청금액 입력
     - `승인 완료`: 승인금액 입력
     - `서류 보완`: 보완 내용, 제출 기한 입력
     - `반려`: 반려 사유 입력
     - `심사 진행`: 추가 입력 없음 (자동)

4. **"알림톡 발송" 버튼 클릭**
   - 전송 중: "발송 중..." 표시
   - 성공: "알림톡이 성공적으로 전송되었습니다!" 알림
   - 실패: 오류 메시지 표시

### 전송 제한 사항

⚠️ **전화번호 필수**
- 클라이언트에게 전화번호가 등록되어 있어야 함
- 전화번호 형식: `010-1234-5678` 또는 `01012345678`

⚠️ **API 키 필수**
- 환경 변수에 API 키가 설정되어 있어야 함
- 설정되지 않으면 콘솔에 경고 메시지 출력

⚠️ **템플릿 승인 필요**
- 5가지 템플릿이 모두 NHN Cloud에서 승인되어야 함
- 승인되지 않은 템플릿은 전송 실패

---

## 문제 해결

### ❌ "전화번호가 등록되지 않았습니다"
**원인**: 선택한 클라이언트에게 전화번호가 없음

**해결**:
1. 클라이언트 정보 수정
2. 전화번호 입력 (예: 010-1234-5678)
3. 저장 후 다시 알림톡 발송 시도

---

### ❌ "알림톡 전송에 실패했습니다. API 키 설정을 확인해주세요."
**원인**: 환경 변수가 설정되지 않았거나 잘못됨

**해결**:
1. `.env.local` 파일 확인
2. API 키가 정확한지 확인
3. 서버 재시작 (`npm run dev -- -p 3001`)

**콘솔 로그 확인**:
```
❌ 카카오 알림톡 API 키가 설정되지 않았습니다.
💡 .env 파일에 다음 값을 추가하세요:
   KAKAO_ALIMTALK_APP_KEY=your_app_key
   KAKAO_ALIMTALK_SECRET_KEY=your_secret_key
   KAKAO_SENDER_KEY=your_sender_key
```

---

### ❌ "유효하지 않은 전화번호 형식입니다"
**원인**: 전화번호 형식이 잘못됨

**올바른 형식**:
- ✅ `010-1234-5678`
- ✅ `01012345678`
- ✅ `010 1234 5678`

**잘못된 형식**:
- ❌ `02-1234-5678` (지역번호는 불가)
- ❌ `1234567890` (010으로 시작해야 함)
- ❌ `010-12345-678` (자릿수 틀림)

---

### ❌ "템플릿을 찾을 수 없습니다"
**원인**: NHN Cloud에 템플릿이 등록되지 않았거나 승인되지 않음

**해결**:
1. NHN Cloud 콘솔 접속
2. KakaoTalk Bizmessage > 템플릿 관리
3. 위 가이드의 5가지 템플릿 등록
4. 템플릿 코드 정확히 입력 (예: `EMF_001`)
5. 카카오 검수 대기 (1-3일)
6. 승인 후 다시 전송 시도

---

### ❌ "발신 프로필이 유효하지 않습니다"
**원인**: Sender Key가 잘못되었거나 채널 상태가 비활성

**해결**:
1. 카카오톡 채널 관리자 센터에서 채널 상태 확인
2. 채널이 "운영중" 상태인지 확인
3. NHN Cloud에서 발신 프로필 연동 확인
4. Sender Key 재확인 및 재입력

---

## 💰 비용 안내

### NHN Cloud 알림톡 요금
- **알림톡**: 약 9원/건 (VAT 별도)
- **친구톡**: 약 17원/건 (VAT 별도)
- **무료 크레딧**: 신규 가입 시 일정 금액 제공

### 월 예상 비용 (예시)
- 클라이언트 100명
- 월 평균 3건씩 전송
- 총 300건 × 9원 = 약 2,700원/월

---

## 🔐 보안 및 개인정보

### 전화번호 보호
- 전화번호는 DB에 암호화 저장 권장
- API 요청 시 HTTPS 사용
- 로그에 전화번호 노출 금지

### API 키 보호
- `.env.local` 파일은 절대 Git에 커밋하지 말 것
- `.gitignore`에 `.env*` 추가 확인
- 프로덕션 환경에서는 환경 변수로 설정

---

## 📞 문의

- **NHN Cloud 고객센터**: support@nhncloud.com
- **카카오 비즈니스 문의**: https://business.kakao.com/info/kakaotalkchannel/

---

## 참고 문서

1. **NHN Cloud 알림톡 가이드**:
   https://docs.nhncloud.com/ko/Notification/KakaoTalk%20Bizmessage/ko/alimtalk-api-guide/

2. **카카오 비즈니스 채널 가이드**:
   https://business.kakao.com/info/kakaotalkchannel/

3. **템플릿 작성 가이드**:
   https://kakaobusiness.gitbook.io/main/ad/bizmessage/templates

---

**마지막 업데이트**: 2026-02-18
**문서 버전**: 1.0
